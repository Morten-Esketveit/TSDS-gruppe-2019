\label{sec:empirical}
% Empirical	Approach
% Description of the empirical model: specification and variables involved
% Strategy for the estimation of the parameters of interest and test of the hypothesis
\subsection{Network Characteristics (T)}
\label{subsec:empirical_network_characteristics}
When analyzing the network we utilize the \texttt{NetworkX} package for Python. We start by characterizing the network. Recall, that we view airports as nodes, and flights between airports as links. Considering the data set of flights in 2018 from the Bureau of Transportation Statistics, we produce a network of US airports and the flights connecting them. We will refer to this network as the US Network. This network has 358 nodes and 3,110 links. Inserting the number of nodes $N$ in equation (\ref{eq:max_links}), the maximum possible number of links would be: 
\begin{align}
    L_{max}  = \frac{358\cdot(358-1)}{2} = 63,903
\end{align}
This implies, that only approximately 5 pct. of possible links are actually found in the network. This sparseness of the network supports the hub-and-spoke view of air transport; rather than having all airports be connected, it is more economically feasible to have certain airports functioning as hubs in their geographical area, and connect to hubs in other regional areas.
\par
Figure \ref{fig:map_general_18} below shows every airport in the network we consider, and the links that connect them. The network is distributed spatially according to the actual geographical locations of the airports, and overlaid on a map of the continental US. From a visual examination the hub-and-spoke nature of the network is clear. Hubs are somewhat distributed geographically and - at a glance - are placed near the larger population centres. Similar maps of the network in 1998 and 2008 can be found in figures \ref{fig:map_general_98} and \ref{fig:map_general_08} in appendix \ref{app:map_general}. The network seems to have been relatively stable over time in the sense that airports that were well connected in 1998 are still well connected in 2018. The business model of a hub-and-spoke structure for the individual airlines is apparent as all of the 15 hubs for the two largest legacy airlines\footnote{Ten hubs of American Airlines, \url{http://news.aa.com/multimedia/default.aspx#factsheets}\\
Eight hubs of Delta Airlines, \url{https://news.delta.com/corporate-stats-and-facts}} are among the large and medium sized hubs, even more so, the network as a whole seem to resemble a hub-and-spoke structure.
\begin{figure}[H]
  \centering
  \caption{Domestic flights network, 2018}
    \includegraphics[width=1. \textwidth]{Exam/Figures/map_general_18}
    \vspace{-0.7cm}
    %\notecenter{Size resembles the degree.}
  \label{fig:map_general_18}
\end{figure}
\noindent
To get a further sense of how the network is connected we calculate the \textit{degree centrality} for each node in the network, i.e. the number of other airports each airport is connected to through flights in 2018. The average degree for the 358 airports contained in the data set is 18,0. This average masks a huge variation; the highest degree found in the data is the O'Hare International Airport (ORD) in Chicago with a degree of 176.  Conversely, 51 airports have a degree of 1, implying that in this data set they only appear in connection with a single other airport.
\par
The degree distribution for each of the years 1998, 2008, and 2018 can be seen in figure \ref{fig:degree_distribution} and can also be grasped in figure \ref{fig:map_general_18} through the size and color of the nodes. Clearly, a large number of airports are connected by flights to few other airports, while a minority of airports are much more connected.
\par
Table \ref{tab: temporal} shows key characteristics of the network for 1998, 2008, and 2018 respectively. For the network in 1998, average shortest path length and diameter is not defined, since the network is not connected. The number of airports has risen substantially in the period, as has the number of unique flight routes. The average degree of the network rose from 1998 to 2008, but fell slightly from 2008 to 2018. One should of course keep in mind, that the rise in the number of airports captures both construction of new airports and if existing airports are serviced by airlines that grow and then meet the inclusion criteria for the sample.
\begin{table}[H]
\centering 
\caption{Network Characteristics, 1998-2018}
\label{tab: temporal}
\begin{tabular}{|l|l|l|l|}
\hline
\textbf{}                    & \textbf{1998} & \textbf{2008} & \textbf{2018} \\ \hline
Nodes                        & 209           & 310           & 355           \\
Links                        & 1614          & 2754          & 3110          \\
Average degree               & 15.5         & 18.1         & 17.5          \\
Average shortest path length & -           & 2.33          & 2.39          \\ 
Diameter                     & -             & 5             & 6           \\
Clustering Coefficient       & 0.63          & 0.65          & 0.57          \\ \hline
\end{tabular}
\end{table}
\noindent
To look into an example of how the network structure has changed over time we investigate the network consisting of the small airport Colorado Springs (COS) and its neighbors in figure \ref{fig:map_COS}. In the left panel we see that COS in 1998 was connected to 11 of the 10 closest inland hubs (except for Las Vegas) and only connected to a single airport that is not one of the absolute mayor hubs to an extent where the average degree between the 12 nodes is 10.8 out of possible 11, resulting in a \textit{clustering coefficient} extremely close to unity. This is as close as one could dream of getting to observing a perfect hub-and-spoke network. In order to fly from COS to any West- or East Coast city (or vice versa) it is mandatory to transfer at one of the 10 bigger inland hubs. Interestingly enough, by 2008 several connections to smaller airports were maintained such that the average degree distribution only was 18.4 out of possible 26. This was followed by a reversion such that COS in 2018 again was almost exclusively connected to mayor hubs. The difference being that one now suddenly did not need to transfer to get directly to Florida or New York by the East Coast or to Las Vegas, LA or Seattle by the West Coast. Though the latter two possibly being down to \textit{Frontier Airlines} as mentioned in subsection \ref{subsec:focus_cities}, the process of establishing Colorado Springs as a focus city with important long distance connections clearly did not stop there. However, we should refrain from extrapolating the development of the role of COS to being a general tendency in the network.
\begin{figure}[H]
  \centering
  \caption{Network of Colorado Springs (COS) and its direct neighbors}
    \begin{subfigure}[t]{0.32\textwidth}
        \centering
        \includegraphics[width=\linewidth]{Exam/Figures/map_COS_98}
    \end{subfigure}
    \hfill
    \begin{subfigure}[t]{0.32\textwidth}
        \centering
        \includegraphics[width=\linewidth]{Exam/Figures/map_COS_08} 
    \end{subfigure}
    \hfill
    \begin{subfigure}[t]{0.32\textwidth}
        \centering
        \includegraphics[width=\linewidth]{Exam/Figures/map_COS_18} 
    \end{subfigure}
  \label{fig:map_COS}
\end{figure}
\noindent
The degree distribution of the network is shown in figure \ref{fig:degree_distribution} with a fitted power-law distribution. The hub-and-spoke nature of the network - and the related fact that it is scale-free - is fairly apparent; a large number of nodes have a low degree, while a few nodes have a degree far above the average degree. 
\begin{figure}[H]
  \centering
  \caption{Degree distribution of network, 1998, 2008 and 2018}
    \includegraphics[width=1 \textwidth]{Exam/Figures/degree_distributionv2.png}
  \label{fig:degree_distribution}
\end{figure}
\noindent
As an alternative measures of centrality in the network, we calculate \textit{betweenness centrality} that measures the degree to which an node is part of the shortest path between two other nodes where path length is defined as the number of traversed links.
% Figur med hhv. degree distribution (til venstre) og betweenness centrality (h√∏jre)?
\par
An overview of our three key network characteristics, and how they relate, can be seen in figure \ref{fig:Btwns_CC}. First of all, there is a clear positive relationship between degree and betweenness centrality; airports that are linked to a large number of other airports are also more likely to be part of a shortest path between two airports. This is fairly unsurprising. Secondly, there is no simple relationship between clustering coefficient and either of the other measures. A large number of airports have clustering coefficient equal to 1, implying that all their neighbors are connected to each other. There is also a number of airports with a clustering coefficient of 0, implying that none of their neighbors are connected to each other, or that they only connect to one other airport.
\begin{figure}[H]
  \centering
  \caption{Betweenness centrality, clustering coefficient and degree, 2018}
    \includegraphics[width=1 \textwidth]{Exam/Figures/NxPairPlot.png}
  \label{fig:Btwns_CC}
\end{figure}
\noindent
In the end, we use clustering coefficient, betweenness and degree as features in the prediction model. Note, that these are all node-specific measures, and as such, for each flight observation, there are two realizations of each measure corresponding to destination and origin airport respectively.

\subsection{Network vulnerability (M)}
We conduct an analysis of how the network is affected when certain nodes are removed. This analysis is broadly in line with the analysis in \cite{chi2004structural}.
\par
Figure \ref{fig:attacks_and_errors} below shows how key network characteristics (average degree, clustering coefficient and global efficiency) are affected, when nodes are removed. One curve corresponds to removal of the most connected nodes, this is what we refer to as an 'attack' on the network, where the hubs are targeted. We likewise consider how the network is affected when we remove the least important nodes first, the occurrence of a so-called 'error'.
\par
%Finally, we consider how the network is affected by an event that removes all network in a geographical area (such as might be the case due to natural disaster and extreme weather conditions). We conduct this analysis by choosing a spot in the continental US, calculating the (geographical) distances from each airport to this spot, and then removing all airports within x miles. This final analysis takes advantage of the spatial nature of the network, and provides insight into how geographically determined failures may affect the network. \\
It should be noted, that in this section we analyze initial consequences for a static network as it is in our data set. Obviously, if a number of airports were to close for a prolonged period (e.g. due to natural disaster), the agents in the market would make changes to the network to accommodate the new situation. Market forces are likely to have been a determinant in producing the network as it is, and exogenous changes to the network would cause changes in behaviour of the agents in the market which would produce a new network.
\begin{figure}[H]
  \centering
  \caption{Effect of node removal on average degree (left) and clustering coefficient (right)}
    \includegraphics[width=1. \textwidth]{Exam/Figures/attacksanderrors.png}
  \label{fig:attacks_and_errors}
\end{figure}
As figure \ref{fig:attacks_and_errors} shows, the removal of a relatively small number of hubs can dramatically alter network characteristics. Unsurprisingly, removal of the least important nodes increases the measures while. Thus, the network is somewhat vulnerable to 'attacks' on the most connected airports.
\par
In the figure, we also show the effect of removing random nodes. Note, that each point represents a "new" network of randomly chosen nodes in the original network. Nodes left out in the first observation may therefore be present in the second observation. Thus, removal of random nodes has close to no persistent effect on average degree or the clustering coefficient of the network due to mean reversion. This again points to the fact that the network is vulnerable only to a concerted attack on several important hubs.

\subsection{Predicting flight prices - Do network-related features add predictive power? (C)}
We want to assess whether network characteristics can contribute in predicting flight prices compared to a prediction model using only a set of baseline variables. Our set of baseline variables include: The number of flights on the given route in the year considered, the distance between the two airports, the (average) time in minutes for the flight and the number of carriers who flew the route during the year considered, as well as dummies for origin and destination airports. Our set of network-related features includes, for both origin and destination airport: Betweenness centrality, degree and clustering coefficient.
\medskip\\
In order to get a sense of the correlation structures, we show all the continuous variables in the correlation plot in figure \ref{fig:correl}. Unsurprisingly, we see that prices are positively correlated with distance and flight duration and negatively with the number of flights on the route due to competition or economies of scale. We see that the rest of the variables, including all our network variables, are only weakly correlated with prices. It is further seen that some of the features exhibit multicollinearity to some degree.
\begin{figure}[H]
  \centering
  \caption{Correlation Plot}
    \includegraphics[width=0.9 \textwidth]{Exam/Figures/corr_plot.pdf}
  \label{fig:correl}
\end{figure}
\noindent
In order to predict prices we use a linear prediction model including network characteristics and other things such as distance, flight duration, and airport dummies as predictors. We follow the procedure outline in section \ref{subsec: prediction model}. The procedure is implemented with the \texttt{SKLEARN} python module from which we use \texttt{train\_test\_split}, \texttt{StandardScaler}, \texttt{ElasticNet}, and  \texttt{CVGridSearch}.\footnote{See github for documentation, \url{https://github.com/Morten-Esketveit/TSDS-gruppe-2019}}
\medskip\\
We use a 5-fold cross-validation and for the grid search we allow the L1-ratio to vary between 0.25 and 1, and the alpha parameter to vary between 1 and 20.\footnote{Prior to fitting the model, we scale the features using the \texttt{StandardScaler} in Python. This is done in order to avoid artificially large/small weights which could make convergence difficult when we are using regularization.} Figure \ref{fig:validation curve} plots the score, measured in terms of $R^2$ as a function of the regularization parameter $\alpha$ for the three highest L1 ratios. Using grid search the optimal $\alpha$ is approximately 6.4 %6.2 
whereas the optimal L1 ratio is 1.
\begin{figure}[H]
  \centering
  \caption{Validation Curves}
    \includegraphics[width=1. \textwidth]{Exam/Figures/validation_curve.pdf}
  \label{fig:validation curve}
\end{figure}
\noindent
Finally, the best model is tested on our test data and the results are compared to the corresponding model without network features. The results are summarized in table \ref{tab: model1}. Our model is able to explain around 40 pct. of the variation in flight prices. We find, that adding network characteristics only increase the out-of-sample prediction marginally, i.e. by 0.5 percentage point. Considering the hyperparametrization both models have a L1 ratio of 1 whereas the $\alpha$ parameter differs slightly. Across the models, the weights of the baseline features are quite similar (see table \ref{tab: coefs} in appendix \ref{app:prediction_model}) for the number of flights, average time, and the number of flights to and from the destination airport. These are the only continuous baseline features with weights that are different from zero. Among the other network features, origin betweenness and both clustering coefficients enters the model with non-zero weights. Based on the size of the coefficients, the clustering coefficient seems to be the most important, however the regularization tends to bias the coefficients. The way the network features enter the model is a result of the correlation structure showed in figure \ref{fig:correl} and the Lasso regularization. Running the model without airport fixed effects (not shown) increases the importance of network characteristics - overall the prediction model performs much worse, however. In this case, the baseline model is able to explain 15.9 percent of the variation whereas the network model can explain 17.9 percent.
\FloatBarrier
\begin{table}[htbp]
  \centering
  \caption{Results, Prediction Model}
  \label{tab: model1}
    \begin{tabular}{rlcccc}
    \hline
          &       & \multicolumn{2}{c}{\textbf{Baseline}} & \multicolumn{2}{c}{\textbf{Networks}} \\ 
          &       & \multicolumn{1}{l}{Test data} & \multicolumn{1}{l}{Training data} & \multicolumn{1}{l}{Test data} & \multicolumn{1}{l}{Training data} \\ \hline
    \multicolumn{1}{l}{Model evaluation} & $R^2$  & \multicolumn{1}{c}{0.421} & \multicolumn{1}{c}{0.427} & \multicolumn{1}{c}{0.426} & \multicolumn{1}{c}{0.431} \\
          &       &  &  \multicolumn{1}{c}{(0.026)}     &       & \multicolumn{1}{c}{(0.028)} \\
    \multicolumn{1}{l}{Hyper parameters} & $\alpha$ & \multicolumn{2}{c}{6.359} & \multicolumn{2}{c}{5.872} \\
          & L1 ratio & \multicolumn{2}{c}{1} & \multicolumn{2}{c}{1} \\ \hline
    \end{tabular}%
  \label{tab:addlabel}%
\end{table}%
\FloatBarrier
